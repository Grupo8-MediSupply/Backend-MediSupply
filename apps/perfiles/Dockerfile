# Etapa de construcciÃ³n
FROM node:22.18-alpine AS builder
WORKDIR /app

ARG APP_NAME
ENV APP_NAME=$APP_NAME

# ğŸ“¦ Copiar solo archivos de dependencias primero (cache layer)

COPY package*.json ./

COPY nx.json ./

COPY tsconfig*.json ./



# ğŸš€ Instalar Nx globalmente y dependencias

RUN npm install -g nx@21.6.4

RUN npm ci --only=production=false



# ğŸ“ Copiar cÃ³digo fuente despuÃ©s de instalar dependencias

COPY . .

# ğŸ—ï¸ Construir la aplicaciÃ³n especÃ­fica (Usa el nombre completo: @medi-supply/perfiles)
RUN nx build $APP_NAME --prod

# Etapa de producciÃ³n
FROM node:22.18-alpine AS production
WORKDIR /app

ARG APP_NAME
ENV NODE_ENV=production

# âœ… SoluciÃ³n al error de ruta (persistencia de variable):
# 1. Definimos la variable de entorno persistente APP_FOLDER_NAME, eliminando el scope.
ENV APP_FOLDER_NAME=$(echo $APP_NAME | sed 's|^@.*/||')

# ğŸ‘¤ Crear usuario no-root por seguridad
# Corregir para incluir todo el comando
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001

# ğŸ“¦ Copiar solo las dependencias de producciÃ³n
COPY package*.json ./
# Usar el comando correcto para producciÃ³n
RUN npm ci --only=production && npm cache clean --force 

# ğŸ“ Copiar artefactos de build y scripts
# Usamos la variable ENV que acabamos de definir
COPY --from=builder --chown=nextjs:nodejs /app/dist/apps/$APP_FOLDER_NAME ./dist
COPY --chown=nextjs:nodejs apps/$APP_FOLDER_NAME/docker-entrypoint.sh ./docker-entrypoint.sh

# ğŸ” Establecer permisos y usuario
RUN chmod +x docker-entrypoint.sh
USER nextjs

# ğŸŒ Exponer puerto
EXPOSE 3000

# ğŸš€ Punto de entrada
ENTRYPOINT ["./docker-entrypoint.sh"]