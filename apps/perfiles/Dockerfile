# Etapa de construcciÃ³n
FROM node:22.18-alpine AS builder
WORKDIR /app

ARG APP_NAME
ENV APP_NAME=$APP_NAME

# ğŸ“¦ Copiar solo archivos de dependencias primero (cache layer)

COPY package*.json ./

COPY nx.json ./

COPY tsconfig*.json ./



# ğŸš€ Instalar Nx globalmente y dependencias

RUN npm install -g nx@21.6.4

RUN npm ci --only=production=false



# ğŸ“ Copiar cÃ³digo fuente despuÃ©s de instalar dependencias

COPY . .

# ğŸ—ï¸ Construir la aplicaciÃ³n especÃ­fica (Usa el nombre completo: @medi-supply/perfiles)
RUN nx build $APP_NAME --prod

# Etapa de producciÃ³n
FROM node:22.18-alpine AS production
WORKDIR /app

# Declaramos APP_NAME de nuevo para la etapa de producciÃ³n
ARG APP_NAME
ENV NODE_ENV=production

# --- ğŸ¯ CORRECCIÃ“N CLAVE EN EL DOCKERFILE ---

# 1. Definir una variable de entorno temporal (usando shell) para la carpeta de salida
#    (ej. de "@medi-supply/perfiles" a "perfiles")
RUN APP_FOLDER_NAME=$(echo $APP_NAME | sed 's|^@.*/||') && \
    export APP_FOLDER_NAME=$APP_FOLDER_NAME && \
    echo "Using build folder: $APP_FOLDER_NAME"

# ... (resto de la configuraciÃ³n del usuario y npm ci)

# ğŸ“ Copiar artefactos de build y scripts
# 2. Usar $APP_FOLDER_NAME para la ruta de origen
COPY --from=builder --chown=nextjs:nodejs /app/dist/apps/$APP_FOLDER_NAME ./dist
COPY --chown=nextjs:nodejs apps/$APP_FOLDER_NAME/docker-entrypoint.sh ./docker-entrypoint.sh

# ğŸ” Establecer permisos y usuario

RUN chmod +x docker-entrypoint.sh

USER nextjs



# ğŸŒ Exponer puerto

EXPOSE 3000



# ğŸš€ Punto de entrada

ENTRYPOINT ["./docker-entrypoint.sh"]