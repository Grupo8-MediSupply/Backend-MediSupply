# Etapa de construcciÃ³n
FROM node:22.18-alpine AS builder
WORKDIR /app

ARG APP_NAME
ENV APP_NAME=$APP_NAME

# ğŸ“¦ Copiar solo archivos de dependencias primero (cache layer)
COPY package*.json ./
COPY nx.json ./
COPY tsconfig*.json ./

# ğŸš€ Instalar Nx globalmente y dependencias
RUN npm install -g nx@21.6.4
RUN npm ci --only=production=false

# ğŸ“ Copiar cÃ³digo fuente despuÃ©s de instalar dependencias
COPY . .

# ğŸ—ï¸ Construir la aplicaciÃ³n especÃ­fica
RUN nx build $APP_NAME --prod

# Etapa de producciÃ³n
FROM node:22.18-alpine AS production
WORKDIR /app

ARG APP_NAME
ENV NODE_ENV=production

# ğŸ‘¤ Crear usuario no-root por seguridad
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001

# ğŸ“¦ Copiar solo las dependencias de producciÃ³n
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

# ğŸ“ Copiar artefactos de build y scripts
COPY --from=builder --chown=nextjs:nodejs /app/dist/apps/$APP_NAME ./dist
COPY --chown=nextjs:nodejs apps/$APP_NAME/docker-entrypoint.sh ./docker-entrypoint.sh

# ğŸ” Establecer permisos y usuario
RUN chmod +x docker-entrypoint.sh
USER nextjs

# ğŸŒ Exponer puerto
EXPOSE 3000

# ğŸš€ Punto de entrada
ENTRYPOINT ["./docker-entrypoint.sh"]