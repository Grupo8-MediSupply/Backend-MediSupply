steps:
  # 1Ô∏è‚É£ Instalar Node y dependencias
  - name: 'node:22.17-bullseye'
    id: 'Install dependencies'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Installing dependencies..."
        npm ci

  # 2Ô∏è‚É£ Detectar apps afectadas
  - name: 'node:22.17-bullseye'
    id: 'Detect affected apps'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Detecting affected projects with Nx..."
        npx nx print-affected --target=build --base=origin/main~1 --head=HEAD --select=projects > /workspace/affected_apps.txt
        echo "Affected apps saved to /workspace/affected_apps.txt"

  # 3Ô∏è‚É£ Construir y pushear Docker images de apps afectadas
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build and push Docker images'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ ! -f /workspace/affected_apps.txt ]; then
          echo "No affected apps detected. Exiting."
          exit 0
        fi
        AFFECTED_APPS=$(cat /workspace/affected_apps.txt)
        if [ -z "$AFFECTED_APPS" ]; then
          echo "No affected apps detected. Exiting."
          exit 0
        fi
        for app in $AFFECTED_APPS; do
          IMAGE="gcr.io/${PROJECT_ID}/${app}"
          echo "üöÄ Building Docker image for $app..."
          docker build -t "$IMAGE" "./apps/$app"
          echo "üì§ Pushing Docker image for $app..."
          docker push "$IMAGE"
        done

  # 4Ô∏è‚É£ Desplegar apps a Cloud Run usando gcloud
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy to Cloud Run'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        AFFECTED_APPS=$(cat /workspace/affected_apps.txt)
        if [ -z "$AFFECTED_APPS" ]; then
          echo "No apps to deploy. Exiting."
          exit 0
        fi
        for app in $AFFECTED_APPS; do
          IMAGE="gcr.io/${PROJECT_ID}/${app}"
          echo "üöÄ Deploying $app to Cloud Run..."
          gcloud run deploy "$app" \
            --image="$IMAGE" \
            --platform=managed \
            --region=us-central1 \
            --quiet

# 5Ô∏è‚É£ Opciones generales de la build
options:
  logging: CLOUD_LOGGING_ONLY  # Evita errores con service accounts

# 6Ô∏è‚É£ Timeout opcional
timeout: "1800s"  # 30 minutos
